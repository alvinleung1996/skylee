<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/debounce.html">

<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<link rel="import" href="../../bower_components/curium-animated-pages/curium-animated-pages.html">
<link rel="import" href="../../bower_components/curium-animated-pages/animations/curium-scene-animation-manager.html">

<link rel="import" href="../skylee-main/skylee-main.html">
<link rel="import" href="../skylee-styles/skylee-styles.html">

<dom-module id="skylee-app">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
        overflow: hidden;
      }
      #scenes {
        width: 100%;
        height: 100%;
      }
    </style>

    <app-location route="{{_route}}" use-hash-as-path></app-location>
    <app-route
      route="{{_route}}"
      pattern="/:sceneID"
      data="{{_routeData}}"
      tail="{{_subroute}}">
    </app-route>

    <curium-scene-animation-manager id="scene-animation-manager"></curium-scene-animation-manager>
    <curium-animated-pages id="scenes" selected-attribute="visible-scene" attr-for-selected="scene-id" selected="[[_selectedSceneID]]" animation-manager="#scene-animation-manager">
      
      <skylee-main scene-id="main" route="{{_subroute}}"></skylee-main> <!-- element already imported -->

    </curium-animated-pages>

  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class SkyleeApp extends Polymer.Element {

      static get is() { return 'skylee-app'; }
      
      static get properties() {
        return {
          _appTitle: {
            type: String,
            computed: '_computeAppTitle(_sceneTitle)',
            observer: '_onAppTitleChanged'
          },
          _sceneTitle: {
            type: String,
            value: ''
          },

          _selectedSceneID: {
            type: String,
            computed: '_computeSelectedSceneID(_routeData.sceneID)'
          }
        };
      }

      constructor() {
        super();

        this._bindedOnSceneTitleChanged = e => this._sceneTitle = e.detail.value;
      }

      ready() {
        super.ready();

        this.$.scenes.addEventListener('iron-select', e => {
          if (e.target === this.$.scenes) this._onSceneSelectionChanged();
        });
        this.$.scenes.addEventListener('iron-deselect', e => {
          if (e.target === this.$.scenes) this._onSceneSelectionChanged();
        });
      }

      _computeSelectedSceneID(id) {
        return id ? id : 'main';
      }

      _onSceneSelectionChanged() {
        this._sceneSelectionDebouncer = Polymer.Debouncer.debounce(this._sceneSelectionDebouncer, Polymer.Async.microTask, () => {

          let selectedScene = this.$.scenes.selectedItem;
          let deselectedScene = this._prevSelectedScene;

          this._prevSelectedScene = selectedScene;

          this._loadScene(selectedScene);
          this._observeSceneProperties(deselectedScene, selectedScene);
          this._syncSceneProperties(selectedScene);
        });
      }

      _loadScene(selectedScene) {
        if (selectedScene) {
          if (selectedScene.hasAttribute('element-path') && !selectedScene.hasAttribute('element-loaded')) {
            let path = selectedScene.getAttribute('element-path');
            Polymer.importHref(this.resolveUrl(path), null, null, true);
            selectedScene.setAttribute('element-loaded', '');
          }
        }
      }

      _observeSceneProperties(deselectedScene, selectedScene) {
        if (deselectedScene) {
          deselectedScene.removeEventListener('scene-title-changed', this._bindedOnSceneTitleChanged);
        }
        if (selectedScene) {
          selectedScene.addEventListener('scene-title-changed', this._bindedOnSceneTitleChanged);
        }
      }

      _syncSceneProperties(selectedScene) {
        let sceneTitle = '';
        if (selectedScene) {
          if (selectedScene.sceneTitle) {
            sceneTitle = selectedScene.sceneTitle;
          } else if (selectedScene.hasAttribute('scene-title')) {
            sceneTitle = selectedScene.getAttribute('scene-title');
          }
        }
        this._sceneTitle = sceneTitle;
      }

      _computeAppTitle(sceneTitle) {
        return (sceneTitle ? (sceneTitle + ' - ') : '') + 'Simon K. Y. Lee Hall';
      }

      _onAppTitleChanged(appTitle) {
        document.title = appTitle;
      }

    }

    window.customElements.define(SkyleeApp.is, SkyleeApp);
    window.Skylee = window.Skylee || {};
    Skylee.SkyleeApp = SkyleeApp;
  </script>
</dom-module>
