<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">

<link rel="import" href="../../bower_components/curium-animated-pages/curium-animated-pages.html">
<link rel="import" href="../../bower_components/curium-animated-pages/animations/curium-tab-page-animation-manager.html">
<link rel="import" href="../../bower_components/curium-responsive-layout/curium-responsive-layout.html">

<link rel="import" href="../skylee-home/skylee-home.html">
<link rel="import" href="../skylee-styles/skylee-styles.html">

<dom-module id="skylee-app">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
        position: relative;
        overflow: hidden;

        --skylee-toolbar-height: var(--skylee-toolbar-normal-height);
      }
      :host([_toolbar-layout="narrow"]) {
        --skylee-toolbar-height: var(--skylee-toolbar-narrow-height);
      }

      #toolbar {
        position: absolute;
        top: 0px;
        left: 0px;
        right: 0px;
        height: var(--skylee-toolbar-height);
        z-index: 100;
        background-color: var(--skylee-primary-color);
        transform: translateY(0%);
        transition: transform 330ms ease-out 0ms,
                    background-color 330ms linear 0ms;
      }
      #toolbar[transparent] {
        background-color: transparent;
      }
      #toolbar[hide] {
        transform: translateY(-100%);
      }
      #toolbar > paper-material {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
      }

      #toolbar-content {
        flex: 0 1 var(--skylee-content-max-width);
        /* fix for Safari: flex-basis percentage only work
           when all the parents have specific height,
           just like the "height" proeprty */
        height: 100%;
        display: flex;
        justify-content: space-between;
        opacity: 1;
        transition: opacity 330ms linear 0ms;
      }
      #toolbar[hide] #toolbar-content {
        opacity: 0;
      }
      :host([_toolbar-layout="narrow"]) #toolbar-content {
        flex-direction: column;
        justify-content: flex-start;
      }
      :host([_toolbar-layout="narrow"]) #toolbar-content > * {
        flex: 0 0 50%;
      }

      #title {
        display: flex;
      }
      :host([_toolbar-layout="narrow"]) #title {
        align-self: flex-start;
      }

      #home-button {
        flex: 1 1 auto;
        text-decoration: none;
        display: flex;
      }
      #home-button > paper-button {
        flex: 1 1 auto;
        margin: 0;
        padding-top: 0;
        padding-bottom: 0;
        @apply --skylee-headline-font;
        color: var(--skylee-themed-primary-text-color);
        text-transform: none;
      }

      #tabs-container {
        position: relative;
      }
      @media screen and (-ms-high-contrast: active), screen and (-ms-high-contrast: none) {  
        /* Fix for IE11 specific styles */
        #tabs-container {
          flex: 1 0 auto;
        }  
      }
      #tabs {
        position: absolute;
        top: 0px;
        right: 0px;
        bottom: 0px;
        height: auto;
        --paper-tabs-selection-bar-color: var(--skylee-themed-primary-text-color);
      }
      :host([_toolbar-layout="narrow"]) #tabs {
        left: 0px;
      }
      #tabs paper-tab {
        --paper-tab-ink: var(--skylee-themed-primary-text-color);
      }
      #tabs paper-tab[link] a {
        /* cannot use paper-tab > a in shadydom */
        padding-left: 12px;
        padding-right: 12px;
        display: flex;
        justify-content: center;
        align-items: center;
        @apply --skylee-subheading-font;
        color: var(--skylee-themed-primary-text-color);
        text-decoration: none;
      }

      #tab-pages {
        width: 100%;
        height: 100%;
      }
      #tab-pages > * {
        background-color: var(--skylee-primary-background-color);
      }
    </style>

    <app-location route="{{_route}}"></app-location>
    <app-route
      route="{{_route}}"
      pattern="/:tabPageID"
      data="{{_routeData}}"
      tail="{{_subroute}}">
    </app-route>

    <curium-responsive-layout id="toolbar" hide$="[[_hideToolbar]]" transparent$="[[_transparentToolbar]]" layout-map='{"0":"narrow","600":"normal"}' layout="{{_toolbarLayout}}">
      <paper-material animated elevation="[[_enableIf(_showToolbarShadow, 2, 0)]]">
        <div id="toolbar-content">

          <div id="title">
            <a id="home-button" href$="[[defaultPath]]" tabindex="-1">
              <paper-button>Simon K. Y. Lee Hall</paper-button>
            </a>
          </div>

          <div id="tabs-container"><!-- provide absolute positioned element so that height 100% can work -->
            <paper-tabs id="tabs" activate-event="" attr-for-selected="tab-id" selected="[[_selectedTabPageID]]" scrollable="[[_isStringEqual(_toolbarLayout, 'narrow')]]" fit-container hide-scroll-buttons>
              <paper-tab tab-id="home" link><a href$="[[defaultPath]]" tabindex="-1">Home</a></paper-tab>
              <paper-tab tab-id="event" link><a href$="[[rootPath]][[routePrefix]]event[[routeSuffix]]" tabindex="-1">Event</a></paper-tab>
              <paper-tab tab-id="team" link><a href$="[[rootPath]][[routePrefix]]team[[routeSuffix]]" tabindex="-1">Team</a></paper-tab>
              <paper-tab tab-id="about" link><a href$="[[rootPath]][[routePrefix]]about[[routeSuffix]]" tabindex="-1">About</a></paper-tab>
              <paper-tab link><a href="https://www.facebook.com/skylee.hku" tabindex="-1" target="_blank">Facebook</a></paper-tab>
            </paper-tabs>
          </div>

        </div>
      </paper-material>
    </curium-responsive-layout>

    <curium-tab-page-animation-manager id="tab-page-animation-manager" duration="330" no-intermediate-page></curium-tab-page-animation-manager>
    <curium-animated-pages
      id="tab-pages"
      attr-for-selected="tab-page-id"
      selected="[[_selectedTabPageID]]"
      fallback-selection="404"
      selected-attribute="visible-tab-page"
      animation-manager="#tab-page-animation-manager">

      <skylee-home tab-page-id="home"></skylee-home> <!-- element already imported -->
      <skylee-event tab-page-id="event" element-path$="[[rootPath]]src/skylee-event/skylee-event.html"></skylee-event>
      <skylee-team tab-page-id="team" element-path$="[[rootPath]]src/skylee-team/skylee-team.html"></skylee-team>
      <skylee-about tab-page-id="about" element-path$="[[rootPath]]src/skylee-about/skylee-about.html"></skylee-about>
      <skylee-404 tab-page-id="404" element-path$="[[rootPath]]src/skylee-404/skylee-404.html"></skylee-404>

    </curium-animated-pages>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class SkyleeApp extends Polymer.mixinBehaviors(Polymer.IronResizableBehavior, Polymer.Element) {

      static get is() { return 'skylee-app'; }

      static get properties() {
        return {
          appTitle: {
            type: String,
            computed: '_computeAppTitle(_tabPageTitle)',
            observer: '_onAppTitleChanged',
            notify: true
          },
          _selectedTabPageID: {
            type: String,
            computed: '_computeSelectedTabPageID(_routeData.tabPageID)'
          },
          _tabPageTitle: {
            type: String,
            value: ''
          },

          routePrefix: {
            value: Skylee.routePrefix
          },
          routeSuffix: {
            value: Skylee.routeSuffix
          },
          defaultPath: {
            value: Skylee.defaultPath
          },

          _toolbarLayout: {
            type: String,
            reflectToAttribute: true,
            observer: '_onToolbarLayoutChanged' /* Fix for ShadyCSS */
          },
          _transparentToolbar: {
            type: Boolean,
            value: false,
            observer: '_onTransparentToolbarChanged'
          },
          _hideToolbar: {
            type: Boolean,
            value: false
          },
          _showToolbarShadow: {
            type: Boolean,
            value: false
          }
        };
      }

      constructor() {
        super();

        this._bindedOnTabPageTitleChanged = e => this._tabPageTitle = e.detail.value;
        this._bindedOnTransparentToolbarChanged = e => this._transparentToolbar = e.detail.value;
        this._bindedOnTabPageScroll = e => this._onTabPageScroll(e);
      }

      ready() {
        super.ready();

        this.$['tab-pages'].addEventListener('iron-select', e => {
          if (e.target === this.$['tab-pages']) this._onTabPageSelectionChanged()
        });
        this.$['tab-pages'].addEventListener('iron-deselect', e => {
          if (e.target === this.$['tab-pages']) this._onTabPageSelectionChanged()
        });
      }

      _computeAppTitle(tabPageTitle) {
        return (tabPageTitle ? (tabPageTitle + ' - ') : '') + 'Simon K. Y. Lee Hall';
      }

      _onAppTitleChanged(appTitle) {
        document.title = appTitle;
      }

      _computeSelectedTabPageID(id) {
        return id ? id : 'home';
      }

      _onToolbarLayoutChanged(layout) {
        /* Fix for ShadyCSS */
        if (window.ShadyCSS && !window.ShadyCSS.nativeCss) {
          let stylesToUpdate = {
            '--skylee-toolbar-height': layout === 'narrow' ? '96px' : '64px'
          };
          this.updateStyles(stylesToUpdate);
          this.$['tab-pages'].items.filter(n => n instanceof Polymer.Element).forEach(n => n.updateStyles(stylesToUpdate));
        }
      }

      _onTabPageSelectionChanged() {
        this._tabPageSelectionDebouncer = Polymer.Debouncer.debounce(this._tabPageSelectionDebouncer, Polymer.Async.microTask, () => {

          let selectedTabPage = this.$['tab-pages'].selectedItem;
          let deselectedTabPage = this._prevSelectedTabPage;

          this._prevSelectedTabPage = selectedTabPage;

          this._loadTabPage(selectedTabPage);
          this._observeTabPageProperties(deselectedTabPage, selectedTabPage);
          this._syncTabPageProperties(selectedTabPage);
          this._setToolbarApperance(selectedTabPage, true);
        });
      }

      _loadTabPage(selectedTabPage) {
        if (selectedTabPage) {
          if (selectedTabPage.hasAttribute('element-path') && !selectedTabPage.hasAttribute('element-loaded')) {
            let path = selectedTabPage.getAttribute('element-path');
            Polymer.importHref(this.resolveUrl(path), null, null, true);
            selectedTabPage.setAttribute('element-loaded', '');
          }
        }
      }

      _observeTabPageProperties(deselectedTabPage, selectedTabPage) {
        if (deselectedTabPage) {
          deselectedTabPage.removeEventListener('tab-page-title-changed', this._bindedOnTabPageTitleChanged);
          deselectedTabPage.removeEventListener('transparent-toolbar-changed', this._bindedOnTransparentToolbarChanged);
          deselectedTabPage.removeEventListener('scroll', this._bindedOnTabPageScroll);
        }
        if (selectedTabPage) {
          selectedTabPage.addEventListener('tab-page-title-changed', this._bindedOnTabPageTitleChanged);
          selectedTabPage.addEventListener('transparent-toolbar-changed', this._bindedOnTransparentToolbarChanged);
          selectedTabPage.addEventListener('scroll', this._bindedOnTabPageScroll);
        }
      }

      _syncTabPageProperties(selectedTabPage, forceShowToolbar) {
        let tabPageTitle = '';
        if (selectedTabPage) {
          if (selectedTabPage.tabPageTitle) {
            tabPageTitle = selectedTabPage.tabPageTitle;
          } else if (selectedTabPage.hasAttribute('tab-page-title')) {
            tabPageTitle = selectedTabPage.getAttribute('tab-page-title');
          }
        }
        this._tabPageTitle = tabPageTitle;
        
        this._transparentToolbar = selectedTabPage && (selectedTabPage.hasAttribute('transparent-toolbar') || selectedTabPage.transparentToolbar);
      }

      _onTransparentToolbarChanged(transparent) {
        this._setToolbarApperance(this.$['tab-pages'].selectedItem, false);
      }

      _onTabPageScroll(evt) {
        this._setToolbarApperance(evt.target, false);
      }

      _setToolbarApperance(selectedTabPage, forceShowToolbar) {
        let newScrollTop = selectedTabPage ? selectedTabPage.scrollTop : 0;
        let oldScrollTop = this._prevTabPageScrollTop || 0;

        this._prevTabPageScrollTop = newScrollTop;

        let toolbarHeight = this._toolbarLayout === 'narrow' ? 96 : 64;
       
        this._hideToolbar = !this._transparentToolbar && !forceShowToolbar && newScrollTop >= toolbarHeight && newScrollTop > oldScrollTop;
        this._showToolbarShadow = !this._transparentToolbar && newScrollTop > 0;
      }

      _isStringEqual(a, b) {
        return a === b;
      }

      _enableIf(condition, a, b) {
        return condition ? a : b;
      }

    }

    window.customElements.define(SkyleeApp.is, SkyleeApp);
  </script>
</dom-module>
