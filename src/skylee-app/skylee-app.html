<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/debounce.html">

<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="../../bower_components/curium-animated-pages/curium-animated-pages.html">
<link rel="import" href="../../bower_components/curium-animated-pages/animations/curium-scene-animation-manager.html">
<link rel="import" href="../../bower_components/curium-route/curium-route.html">

<link rel="import" href="../skylee-property-binder-behavior/skylee-property-binder-behavior.html">
<link rel="import" href="../skylee-styles/skylee-styles.html">

<link rel="import" href="../skylee-tab-pages/skylee-tab-pages.html">

<dom-module id="skylee-app">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
      }
      #scenes {
        width: 100%;
        height: 100%;
      }
    </style>

    <app-location route="{{_route}}"></app-location>
    <curium-route
      route="{{_route}}"
      data-pattern="/sceneId"
      data="{{_routeData}}">
    </curium-route>

    <curium-scene-animation-manager id="scene-animation-manager" duration="330"></curium-scene-animation-manager>
    <curium-animated-pages
      id="scenes"
      attr-for-selected="scene-id"
      selected="[[_selectedSceneId]]"
      selected-attribute="visible-scene"
      animation-manager="#scene-animation-manager">

      <skylee-tab-pages
        scene-id="tab-pages"
        route="[[_route]]"></skylee-tab-pages> <!-- element already imported -->

      <skylee-image-viewer level="1"
        scene-id="image-viewer" element-path$="[[rootPath]]src/skylee-image-viewer/skylee-image-viewer.html"
        route="[[_route]]"></skylee-image-viewer>

    </curium-animated-pages>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class SkyleeApp extends Skylee.SkyleePropertyBinderBehavior(Polymer.mixinBehaviors(Polymer.IronResizableBehavior, Polymer.Element)) {

      static get is() { return 'skylee-app'; }

      static get properties() {
        return {
          appTitle: {
            type: String,
            computed: '_computeAppTitle(_sceneTitle)',
            observer: '_onAppTitleChanged'
          },
          _sceneTitle: {
            type: String,
            value: ''
          },

          _selectedSceneId: {
            type: String,
            computed: '_computeSelectedSceneId(_routeData.sceneId)'
          },
          _tabPagesRoute: {
            type: Object
          }
        };
      }

      ready() {
        super.ready();
        this.$.scenes.addEventListener('iron-select', e => {
          if (e.target === this.$.scenes) this._onSceneSelectionChanged()
        });
        this.$.scenes.addEventListener('iron-deselect', e => {
          if (e.target === this.$.scenes) this._onSceneSelectionChanged()
        });
      }

      _computeAppTitle(sceneTitle) {
        return (sceneTitle ? (sceneTitle + ' - ') : '') + 'Simon K. Y. Lee Hall';
      }

      _onAppTitleChanged(appTitle) {
        document.title = appTitle;
      }

      _computeSelectedSceneId(id) {
        return id === 'image-viewer' ? 'image-viewer' : 'tab-pages';
      }

      _onSceneSelectionChanged() {
        this._sceneSelectionDebouncer = Polymer.Debouncer.debounce(this._sceneSelectionDebouncer, Polymer.Async.microTask, () => {

          let selectedScene = this.$.scenes.selectedItem;
          let deselectedScene = this._prevSelectedScene;

          this._prevSelectedScene = selectedScene;

          this._loadScene(selectedScene);
          this._bindSceneProperties(selectedScene);
        });
      }

      _loadScene(selectedScene) {
        if (selectedScene) {
          if (selectedScene.hasAttribute('element-path') && !selectedScene.hasAttribute('element-loading') && !selectedScene.hasAttribute('element-loaded')) {
            let path = selectedScene.getAttribute('element-path');
            selectedScene.setAttribute('element-loading', '');
            Polymer.importHref(this.resolveUrl(path), () => {
              selectedScene.removeAttribute('element-loading');
              selectedScene.setAttribute('element-loaded', '');
            }, null, true);
          }
        }
      }

      _bindSceneProperties(selectedScene) {
        this._bindProperties({
          _sceneTitle: 'sceneTitle'
        }, selectedScene);
      }

    }
    window.customElements.define(SkyleeApp.is, SkyleeApp);
  </script>
</dom-module>
