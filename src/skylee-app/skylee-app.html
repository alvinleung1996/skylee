<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/debounce.html">

<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="../../bower_components/curium-animated-pages/curium-animated-pages.html">
<link rel="import" href="../../bower_components/curium-animated-pages/animations/curium-scene-animation-manager.html">
<link rel="import" href="../../bower_components/curium-route/curium-route.html">

<link rel="import" href="../skylee-property-binder-behavior/skylee-property-binder-behavior.html">
<link rel="import" href="../skylee-styles/skylee-styles.html">

<link rel="import" href="../skylee-pages/skylee-pages.html">

<dom-module id="skylee-app">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
      }
      #scenes {
        width: 100%;
      }
    </style>

    <app-location route="{{_rawRoute}}"></app-location>
    <curium-route
      route="{{_route}}"
      data-pattern="/sceneId"
      data="{{_routeData}}"
      tail="{{_subroute}}">
    </curium-route>

    <curium-scene-animation-manager id="scene-animation-manager" duration="330"></curium-scene-animation-manager>
    <curium-animated-pages
      id="scenes"
      attr-for-selected="scene-id"
      selected="[[_routeData.sceneId]]"
      selected-attribute="visible-scene">

      <skylee-pages
        scene-id="page"
        route="[[_subroute]]"></skylee-pages> <!-- element already imported -->

      <skylee-image-viewer level="1"
        scene-id="image-viewer" element-path$="[[rootPath]]src/skylee-image-viewer/skylee-image-viewer.html"
        route="[[_subroute]]"></skylee-image-viewer>

    </curium-animated-pages>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class SkyleeApp extends Skylee.SkyleePropertyBinderBehavior(Polymer.mixinBehaviors(Polymer.IronResizableBehavior, Polymer.Element)) {

      static get is() { return 'skylee-app'; }

      static get properties() {
        return {
          appTitle: {
            type: String,
            computed: '_computeAppTitle(_sceneTitle)',
            observer: '_onAppTitleChanged'
          },
          _sceneTitle: {
            type: String,
            value: ''
          },

          addressBarBackgroundColor: {
            type: String,
            value: '',
            observer: '_onAddressBarBackgroundColorChanged'
          },



          _route: {
            type: Object
          },
        };
      }

      static get observers() { return [
        '_onRawRouteChanged(_rawRoute.*)'
      ];}

      ready() {
        super.ready();
        this.$.scenes.addEventListener('iron-select', e => {
          if (e.target === this.$.scenes) this._onSceneSelectionChanged()
        });
        this.$.scenes.addEventListener('iron-deselect', e => {
          if (e.target === this.$.scenes) this._onSceneSelectionChanged()
        });
      }



      _computeAppTitle(sceneTitle) {
        return (sceneTitle ? (sceneTitle + ' - ') : '') + 'Simon K. Y. Lee Hall';
      }

      _onAppTitleChanged(appTitle) {
        document.title = appTitle;
      }



      _onAddressBarBackgroundColorChanged(color) {
        let meta = document.head.querySelector('meta[name="theme-color"]');
        if (meta) {
          if (!color) {
            if (window.ShadyCSS && !window.ShadyCSS.nativeCss) {
              color = ShadyCSS.getComputedStyleValue(this, '--skylee-background--app-theme--primary_background-color');
            } else {
              color = getComputedStyle(this).getPropertyValue('--skylee-background--app-theme--primary_background-color');
            }
          }
          meta.setAttribute('content', color);
        }
      }



      _onRawRouteChanged(rawChangeRecord) {
        if (rawChangeRecord.base) {
          let rawPath = rawChangeRecord.base.path;
          let path = /^\/image\-viewer(?:\/|$)/.test(rawPath) ? rawPath : `/page${rawPath}`;
          this._route = {
            prefix: '',
            path: path
          };
        }
      }



      _onSceneSelectionChanged() {
        this._sceneSelectionDebouncer = Polymer.Debouncer.debounce(this._sceneSelectionDebouncer, Polymer.Async.microTask, () => {

          let selectedScene = this.$.scenes.selectedItem;
          let deselectedScene = this._prevSelectedScene;

          this._prevSelectedScene = selectedScene;

          this._loadScene(selectedScene);
          this._bindSceneProperties(selectedScene);
        });
      }

      _loadScene(selectedScene) {
        if (selectedScene) {
          if (selectedScene.hasAttribute('element-path') && !selectedScene.hasAttribute('element-loading') && !selectedScene.hasAttribute('element-loaded')) {
            let path = selectedScene.getAttribute('element-path');
            selectedScene.setAttribute('element-loading', '');
            Polymer.importHref(this.resolveUrl(path), () => {
              selectedScene.removeAttribute('element-loading');
              selectedScene.setAttribute('element-loaded', '');
            }, () => {
              selectedScene.removeAttribute('element-loading');
            }, true);
          }
        }
      }

      _bindSceneProperties(selectedScene) {
        this._bindProperties({
          _sceneTitle: { target: selectedScene, name: 'sceneTitle', mode: 'up' },
          addressBarBackgroundColor: { target: selectedScene, name: 'addressBarBackgroundColor', mode: 'up' }
        });
      }

    }
    window.customElements.define(SkyleeApp.is, SkyleeApp);
  </script>
</dom-module>
