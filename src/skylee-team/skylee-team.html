<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="../../bower_components/curium-animated-pages/curium-animated-pages.html">
<link rel="import" href="../../bower_components/curium-animated-pages/animations/curium-scene-animation-manager.html">
<link rel="import" href="../../bower_components/curium-route/curium-route.html">

<link rel="import" href="../skylee-property-binder-behavior/skylee-property-binder-behavior.html">
<link rel="import" href="all/skylee-team-all.html">

<dom-module id="skylee-team">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
        overflow: hidden;
        background-color: var(--skylee-background--secondary_background-color);
      }
      #team-pages {
        width: 100%;
        height: 100%;
      }
    </style>

    <curium-route
      route="{{route}}"
      prefix-pattern="/team"
      data-pattern="/teamPageID"
      data="{{_routeData}}"
      tail="{{_subroute}}">
    </curium-route>

    <curium-scene-animation-manager id="team-page-animation-manager" duration="330"></curium-scene-animation-manager>
    <curium-animated-pages
      id="team-pages"
      attr-for-selected="team-page-id"
      selected="[[_selectedTeamPageID]]"
      animation-manager="#team-page-animation-manager">

      <skylee-team-all team-page-id="all" toolbar-height="[[toolbarHeight]]"></skylee-team-all> <!-- element already imported -->

      <skylee-team-badminton level="1" team-page-id="badminton"
        element-path$="[[rootPath]]src/skylee-team/badminton/skylee-team-badminton.html"
        toolbar-height="[[toolbarHeight]]" route="[[_subroute]]"></skylee-team-badminton>

      <skylee-team-basketball level="1" team-page-id="basketball"
        element-path$="[[rootPath]]src/skylee-team/basketball/skylee-team-basketball.html"
        toolbar-height="[[toolbarHeight]]" route="[[_subroute]]"></skylee-team-badminton>

    </curium-animated-pages>

  </template>
  <script>
    class SkyleeTeam extends Skylee.SkyleePropertyBinderBehavior(Polymer.mixinBehaviors(Polymer.IronResizableBehavior, Polymer.Element)) {
      
      static get is() { return 'skylee-team'; }

      static get properties() {
        return {
          route: Object,
          toolbarHeight: Number,

          tabPageTitle: {
            type: String,
            computed: '_computeTabPageTitle(_teamPageTitle)',
            notify: true
          },
          hideToolbar: {
            type: Boolean,
            value: false,
            readOnly: true,
            notify: true
          },
          showToolbarShadow: {
            type: Boolean,
            value: false,
            readOnly: true,
            notify: true
          },
          toolbarBackButtonUrl: {
            type: String,
            readOnly: true,
            notify: true
          },

          _selectedTeamPageID: {
            type: String,
            computed: '_computeSelectedTeamPageID(_routeData.teamPageID)'
          },
          _teamPageTitle: {
            type: String
          }
        };
      }

      ready() {
        super.ready();
        this.$['team-pages'].addEventListener('iron-select', e => {
          if (e.target === this.$['team-pages']) this._onTeamPageSelectionChanged();
        })
        this.$['team-pages'].addEventListener('iron-deselect', e => {
          if (e.target === this.$['team-pages']) this._onTeamPageSelectionChanged();
        })
      }

      _computeTabPageTitle(teamPageTitle) {
        return teamPageTitle || 'Team';
      }

      _computeSelectedTeamPageID(id) {
        return id || 'all';
      }

      _onTeamPageSelectionChanged() {
        this._teamPageSelectionDebouncer = Polymer.Debouncer.debounce(this._teamPageSelectionDebouncer, Polymer.Async.microTask, () => {

          let selectedTeamPage = this.$['team-pages'].selectedItem;
          let deselectedTeamPage = this._prevSelectedTeamPage;

          this._prevSelectedTeamPage = selectedTeamPage;

          this._loadTeamPage(selectedTeamPage);
          this._bindTeamPageProperties(selectedTeamPage);
        });
      }

      _loadTeamPage(selectedTeamPage) {
        if (selectedTeamPage) {
          if (selectedTeamPage.hasAttribute('element-path') && !selectedTeamPage.hasAttribute('element-loading') && !selectedTeamPage.hasAttribute('element-loaded')) {
            let path = this.resolveUrl(selectedTeamPage.getAttribute('element-path'));
            selectedTeamPage.setAttribute('element-loading', '');
            Polymer.importHref(path, () => {
              selectedTeamPage.removeAttribute('element-loading');
              selectedTeamPage.setAttribute('element-loaded', '');
            }, null, true);
          }
        }
      }

      _bindTeamPageProperties(selectedTeamPage) {
        this._bindProperties({
          _teamPageTitle: 'teamPageTitle',
          hideToolbar: 'hideToolbar',
          showToolbarShadow: 'showToolbarShadow',
          toolbarBackButtonUrl: 'toolbarBackButtonUrl'
        }, selectedTeamPage);
      }

    }
    window.customElements.define(SkyleeTeam.is, SkyleeTeam);
  </script>
</dom-module>
