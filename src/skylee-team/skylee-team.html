<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="../../bower_components/curium-animated-pages/curium-animated-pages.html">
<link rel="import" href="../../bower_components/curium-animated-pages/animations/curium-scene-animation-manager.html">

<link rel="import" href="skylee-team-all.html">

<dom-module id="skylee-team">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
        overflow: hidden;
        background-color: var(--skylee-background--secondary_background-color);
      }
      #team-pages {
        width: 100%;
        height: 100%;
      }
    </style>

    <app-route
      route="{{route}}"
      pattern="/:teamPageID"
      data="{{_routeData}}">
    </app-route>

    <curium-scene-animation-manager id="team-page-animation-manager" duration="330"></curium-scene-animation-manager>
    <curium-animated-pages
      id="team-pages"
      attr-for-selected="team-page-id"
      selected="[[_selectedTeamPageID]]"
      animation-manager="#team-page-animation-manager">

      <skylee-team-all team-page-id="all"></skylee-team-all> <!-- element already imported -->

    </curium-animated-pages>

  </template>
  <script>
    class SkyleeTeam extends Polymer.mixinBehaviors(Polymer.IronResizableBehavior, Polymer.Element) {
      
      static get is() { return 'skylee-team'; }

      static get properties() {
        return {
          route: Object,

          tabPageTitle: {
            type: String,
            value: 'Team',
            notify: true
          },
          customScrollTop: {
            type: Number,
            value: 0,
            observer: '_onCustomScrollTopChanged'
          },

          _selectedTeamPageID: {
            type: String,
            computed: '_computeSelectedTeamPageID(_routeData.teamPageID)'
          },
          _teamPageTitle: {
            type: String
          }
        };
      }

      constructor() {
        super();
        this._bindedOnTeamPageTitleChanged = e => this._teamPageTitle = e.detail.value;
        this._bindedOnTeamPageScroll = e => this._onTeamPageScroll(e);
      }

      ready() {
        super.ready();
        this.$['team-pages'].addEventListener('iron-select', e => {
          if (e.target === this.$['team-pages']) this._onTeamPageSelectionChanged();
        })
        this.$['team-pages'].addEventListener('iron-deselect', e => {
          if (e.target === this.$['team-pages']) this._onTeamPageSelectionChanged();
        })
      }

      _computeSelectedTeamPageID(id) {
        return id || 'all';
      }

      _onTeamPageSelectionChanged() {
        this._teamPageSelectionDebouncer = Polymer.Debouncer.debounce(this._teamPageSelectionDebouncer, Polymer.Async.microTask, () => {

          let selectedTeamPage = this.$['team-pages'].selectedItem;
          let deselectedTeamPage = this._prevSelectedTeamPage;
          this._prevSelectedTeamPage = selectedTeamPage;

          this._loadTeamPage(selectedTeamPage);
          this._observeTeamPageProperties(deselectedTeamPage, selectedTeamPage);
          this._syncTeamPageProperties(selectedTeamPage);
        });
      }

      _loadTeamPage(selectedTeamPage) {
        if (selectedTeamPage) {
          if (selectedTeamPage.hasAttribute('element-path') && !selectedTeamPage.hasAttribute('element-loading') && !selectedTeamPage.hasAttribute('element-loaded')) {
            let path = this.resolveUrl(selectedTeamPage.getAttribute('element-path'));
            selectedTeamPage.setAttribute('element-loading', '');
            Polymer.importHref(path, () => {
              selectedTeamPage.removeAttribute('element-loading');
              selectedTeamPage.setAttribute('element-loaded', '');
            }, null, true);
          }
        }
      }
      
      _observeTeamPageProperties(deselectedTeamPage, selectedTeamPage) {
        if (deselectedTeamPage) {
          deselectedTeamPage.removeEventListener('team-page-title-changed', this._bindedOnTeamPageTitleChanged);
          deselectedTeamPage.removeEventListener('scroll', this._bindedOnTeamPageScroll);
        }
        if (selectedTeamPage) {
          selectedTeamPage.addEventListener('team-page-title-changed', this._bindedOnTeamPageTitleChanged);
          selectedTeamPage.addEventListener('scroll', this._bindedOnTeamPageScroll);
        }
      }

      _syncTeamPageProperties(selectedTeamPage) {
        if (selectedTeamPage) {
          if (selectedTeamPage.hasAttribute('team-page-title')) {
            this._teamPageTitle =selectedTeamPage.getAttribute('team-page-title');
          } else if (selectedTeamPage.teamPageTitle) {
            this._teamPageTitle = selectedTeamPage.teamPageTitle;
          } else {
            this._teamPageTitle = '';
          }
        }

        if (selectedTeamPage) {
          this.customScrollTop = selectedTeamPage.scrollTop;
        } else {
          this.customScrollTop = 0;
        }
      }

      _onTeamPageScroll(evt) {
        this.customScrollTop = evt.target.scrollTop;
      }

      _onCustomScrollTopChanged(customScrollTop) {
        this.dispatchEvent(new CustomEvent('custom-scroll', {
          bubbles: false,
          cancelable: false,
          detail: {
            customScrollTop: customScrollTop
          }
        }));

      }
    }
    window.customElements.define(SkyleeTeam.is, SkyleeTeam);
  </script>
</dom-module>
